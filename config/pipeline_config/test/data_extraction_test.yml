name: data_extraction

models:
  - name: espn_matches
    description: Extracts match information from the ESPN json data.
    trigger: automatic
    sources:
      - name: espn_matches
        path: landing/espn_matches.json
        mode: newest # newest, all
        on: created_at
    columns:
      - name: id
        unique: true
      - name: date
      - name: name
      - name: shortName
      - name: season_year
      - name: venue
      - name: leg_value
      - name: leg_displayValue
      - name: team_A_id
      - name: team_A_homeAway
      - name: team_A_winner
      - name: team_A_score
      - name: team_A_abbreviation
      - name: team_A_displayName
      - name: team_A_shortDisplayName
      - name: team_A_name
      - name: team_A_location
      - name: team_A_venue_id
      - name: team_B_id
      - name: team_B_homeAway
      - name: team_B_winner
      - name: team_B_score
      - name: team_B_abbreviation
      - name: team_B_displayName
      - name: team_B_shortDisplayName
      - name: team_B_name
      - name: team_B_location
      - name: team_B_venue_id 
      - name: landing_created_at
      - name: created_at
        static: !date_offset 0
    function: extract_from_json
    params:
      - columns_mapping:
          direct_paths:
            id: id
            date: date
            name: name
            shortName: shortName
            season_year: season.year
            venue: venue.displayName
            leg_value: competitions.0.leg.value
            leg_displayValue: competitions.0.leg.displayValue
            team_A_id: competitions.0.competitors.0.id
            team_A_homeAway: competitions.0.competitors.0.homeAway
            team_A_winner: competitions.0.competitors.0.winner
            team_A_score: competitions.0.competitors.0.score
            team_A_abbreviation: competitions.0.competitors.0.team.abbreviation
            team_A_displayName: competitions.0.competitors.0.team.displayName
            team_A_shortDisplayName: competitions.0.competitors.0.team.shortDisplayName
            team_A_name: competitions.0.competitors.0.team.name
            team_A_location: competitions.0.competitors.0.team.location
            team_A_venue_id: competitions.0.competitors.0.team.venue.id
            team_B_id: competitions.0.competitors.1.id
            team_B_homeAway: competitions.0.competitors.1.homeAway
            team_B_winner: competitions.0.competitors.1.winner
            team_B_score: competitions.0.competitors.1.score
            team_B_abbreviation: competitions.0.competitors.1.team.abbreviation
            team_B_displayName: competitions.0.competitors.1.team.displayName
            team_B_shortDisplayName: competitions.0.competitors.1.team.shortDisplayName
            team_B_name: competitions.0.competitors.1.team.name
            team_B_location: competitions.0.competitors.1.team.location
            team_B_venue_id: competitions.0.competitors.1.team.venue.id
            landing_created_at: created_at
    dependencies:
      - landing.espn_matches
    output:
      path: intermediate/espn_matches.csv

  - name: football_data_matches
    description: Extracts match information from the Football Data Matches json data.
    trigger: automatic
    sources:
      - name: football_data_matches
        path: landing/football_data_matches.json
        mode: newest
        on: created_at
    columns:
      - name: area_id
      - name: area_name
      - name: area_code
      - name: competition_id
      - name: competition_name
      - name: competition_code
      - name: competition_type
      - name: season_id
      - name: season_start_date
      - name: season_end_date
      - name: season_current_matchday
      - name: id
        unique: true
      - name: utcDate
      - name: status
      - name: matchday
      - name: stage
      - name: homeTeam_id
      - name: homeTeam_name
      - name: homeTeam_shortName
      - name: homeTeam_tla
      - name: awayTeam_id
      - name: awayTeam_name
      - name: awayTeam_shortName
      - name: awayTeam_tla
      - name: winner
      - name: score_fullTime_home
      - name: score_fullTime_away
      - name: score_halfTime_home
      - name: score_halfTime_away
      - name: score_regularTime_home
      - name: score_regularTime_away
      - name: score_extraTime_home
      - name: score_extraTime_away
      - name: score_penalties_home
      - name: score_penalties_away
      - name: landing_created_at
      - name: created_at
        static: !date_offset 0
    function: extract_from_json
    params:
      - columns_mapping:
          direct_paths:
            area_id: area.id
            area_name: area.name
            area_code: area.code
            competition_id: competition.id
            competition_name: competition.name
            competition_code: competition.code
            competition_type: competition.type
            season_id: season.id
            season_start_date: season.startDate
            season_end_date: season.endDate
            season_current_matchday: season.currentMatchday
            id: id
            utcDate: utcDate
            status: status
            matchday: matchday
            stage: stage
            homeTeam_id: homeTeam.id
            homeTeam_name: homeTeam.name
            homeTeam_shortName: homeTeam.shortName
            homeTeam_tla: homeTeam.tla
            awayTeam_id: awayTeam.id
            awayTeam_name: awayTeam.name
            awayTeam_shortName: awayTeam.shortName
            awayTeam_tla: awayTeam.tla
            winner: score.winner
            score_fullTime_home: score.fullTime.home
            score_fullTime_away: score.fullTime.away
            score_halfTime_home: score.halfTime.home
            score_halfTime_away: score.halfTime.away
            score_regularTime_home: score.regularTime.home
            score_regularTime_away: score.regularTime.away
            score_extraTime_home: score.extraTime.home
            score_extraTime_away: score.extraTime.away
            score_penalties_home: score.penalties.home
            score_penalties_away: score.penalties.away
            landing_created_at: created_at
    dependencies:
      - landing.football_data_matches
    output:
      path: intermediate/football_data_matches.csv

  - name: football_data_standings
    description: Extracts standings information from the Football Data Standings json data.
    trigger: automatic
    sources:
      - name: football_data_standings
        path: landing/football_data_standings.json
        mode: newest
        on: created_at
    columns:
      - name: area_id
      - name: area_name
      - name: area_code
      - name: competition_id
        unique: true
      - name: competition_name
      - name: competition_code
      - name: competition_type
      - name: season_id
        unique: true
      - name: season_startDate
      - name: season_endDate
      - name: season_currentMatchday
      - name: season_winner
      - name: stage
      - name: type
      - name: group
      - name: position
      - name: team_id
        unique: true
      - name: team_name
      - name: team_shortName
      - name: team_tla
      - name: playedGames
      - name: won
      - name: draw
      - name: lost
      - name: points
      - name: goalsFor
      - name: goalsAgainst
      - name: goalDifference
      - name: landing_created_at
      - name: created_at
        static: !date_offset 0
    function: extract_from_json
    params:
      - columns_mapping:
          direct_paths:
            area_id: area.id
            area_name: area.name
            area_code: area.code
            competition_id: competition.id
            competition_name: competition.name
            competition_code: competition.code
            competition_type: competition.type
            season_id: season.id
            season_startDate: season.startDate
            season_endDate: season.endDate
            season_currentMatchday: season.currentMatchday
            season_winner: season.winner
            stage: standings.0.stage
            type: standings.0.type
            group: standings.0.group
            landing_created_at: created_at
          iterate:
            path: standings.0.table
            columns:
              position: position
              team_id: team.id
              team_name: team.name
              team_shortName: team.shortName
              team_tla: team.tla
              playedGames: playedGames
              won: won
              draw: draw
              lost: lost
              points: points
              goalsFor: goalsFor
              goalsAgainst: goalsAgainst
              goalDifference: goalDifference
    dependencies:
      - landing.football_data_standings
    output: 
      path: intermediate/football_data_standings.csv

  - name: espn_teams
    description: Extracts team information from the ESPN matches data.
    trigger: automatic
    sources: 
      - name: espn_matches
        path: intermediate/espn_matches.csv
        mode: newest
        on: created_at
    columns:
      - name: team_id
        unique: true
      - name: team_name
      - name: team_abbreviation
      - name: team_displayName
      - name: team_shortDisplayName
      - name: created_at
        static: !date_offset 0
    function: extract_parallel_entities
    params:
      - columns_mapping: 
          team_id: [team_A_id, team_B_id]
          team_name: [team_A_name, team_B_name]
          team_abbreviation: [team_A_abbreviation, team_B_abbreviation]
          team_displayName: [team_A_displayName, team_B_displayName]
          team_shortDisplayName: [team_A_shortDisplayName, team_B_shortDisplayName]
        deduplicate: true
    dependencies:
      - intermediate.espn_matches
    output: 
      path: intermediate/espn_teams.csv
